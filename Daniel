import streamlit as st
import pandas as pd
import sqlite3
from datetime import datetime, timedelta

# Configura√ß√µes iniciais
st.set_page_config(page_title="Gest√£o de Transportes Pro", layout="wide")

# --- BANCO DE DADOS ---
conn = sqlite3.connect('financeiro_transporte.db', check_same_thread=False)
c = conn.cursor()
c.execute('''CREATE TABLE IF NOT EXISTS financeiro 
             (tipo TEXT, categoria TEXT, valor REAL, sinal_pct REAL, km_inicial REAL, km_final REAL, data TEXT)''')
conn.commit()

# --- SIDEBAR (METAS E NAVEGA√á√ÉO) ---
st.sidebar.title("Configura√ß√µes")
meta_diaria = st.sidebar.number_input("Sua Meta Di√°ria (R$)", value=300.0)
menu = st.sidebar.selectbox("Ir para:", ["Registrar Hoje", "Relat√≥rios Di√°rios", "Vis√£o Semana/M√™s"])

# --- L√ìGICA DE REGISTRO ---
if menu == "Registrar Hoje":
    st.header("üìù Registro de Atividades")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.subheader("Entradas")
        tipo_entrada = st.selectbox("Categoria de Entrada", ["Uber", "Comiss√£o", "Particular", "Transfer", "City tour", "Outros"])
        valor_total = st.number_input("Valor Total do Servi√ßo (R$)", min_value=0.0)
        
        # Campo de Sinal para City Tour e Transfer
        sinal = 0.0
        if tipo_entrada in ["Transfer", "City tour"]:
            sinal = st.slider("Sinal recebido (%)", 0, 100, 0)
            valor_sinal = (valor_total * sinal) / 100
            st.info(f"Valor do Sinal: R$ {valor_sinal:.2f}")

    with col2:
        st.subheader("Sa√≠das / KM")
        cat_saida = st.selectbox("Categoria de Sa√≠da", ["Nenhuma", "Gasolina", "Alimenta√ß√£o", "Mercado", "Contas de Consumo", "Aluguel carro", "Aluguel casa"])
        valor_saida = st.number_input("Valor da Sa√≠da (R$)", min_value=0.0)
        
        st.divider()
        km_i = st.number_input("KM Inicial", min_value=0.0)
        km_f = st.number_input("KM Final", min_value=0.0)

    if st.button("Salvar Registro"):
        data_hoje = datetime.now().strftime("%Y-%m-%d")
        # Salva Entrada (se houver)
        if valor_total > 0:
            c.execute("INSERT INTO financeiro VALUES (?, ?, ?, ?, ?, ?, ?)", 
                      ('Entrada', tipo_entrada, valor_total, sinal, km_i, km_f, data_hoje))
        # Salva Sa√≠da (se houver)
        if valor_saida > 0:
            c.execute("INSERT INTO financeiro VALUES (?, ?, ?, ?, ?, ?, ?)", 
                      ('Sa√≠da', cat_saida, valor_saida, 0, 0, 0, data_hoje))
        conn.commit()
        st.success("Dados salvos com sucesso!")

# --- L√ìGICA DE RELAT√ìRIOS ---
else:
    df = pd.read_sql_query("SELECT * FROM financeiro", conn)
    df['data'] = pd.to_datetime(df['data'])
    
    if menu == "Relat√≥rios Di√°rios":
        hoje = datetime.now().date()
        df_hoje = df[df['data'].dt.date == hoje]
        
        ganho_hoje = df_hoje[df_hoje['tipo'] == 'Entrada']['valor'].sum()
        gasto_hoje = df_hoje[df_hoje['tipo'] == 'Sa√≠da']['valor'].sum()
        
        st.header(f"Resumo de Hoje: {hoje.strftime('%d/%m/%Y')}")
        
        # Barra de Meta
        progresso = min(ganho_hoje / meta_diaria, 1.0) if meta_diaria > 0 else 0
        st.write(f"Meta Di√°ria: R$ {ganho_hoje:.2f} / R$ {meta_diaria:.2f}")
        st.progress(progresso)
        
        col1, col2, col3 = st.columns(3)
        col1.metric("Ganhos", f"R$ {ganho_hoje:.2f}")
        col2.metric("Gastos", f"R$ {gasto_hoje:.2f}")
        col3.metric("Saldo", f"R$ {ganho_hoje - gasto_hoje:.2f}")

import streamlit as st
import pandas as pd
import sqlite3
import plotly.express as px
from datetime import datetime, timedelta

# --- CONFIGURA√á√ÉO DA P√ÅGINA ---
st.set_page_config(page_title="Daniel | Gest√£o Integrada", layout="wide")

# --- BANCO DE DADOS ---
conn = sqlite3.connect('gestao_daniel_final.db', check_same_thread=False)
c = conn.cursor()

# Tabela de Caixa (Onde os gr√°ficos buscam dados)
c.execute('''CREATE TABLE IF NOT EXISTS financeiro 
             (id INTEGER PRIMARY KEY AUTOINCREMENT, tipo TEXT, cat TEXT, valor REAL, data DATE)''')

# Tabela de Agenda
c.execute('''CREATE TABLE IF NOT EXISTS agenda 
             (id INTEGER PRIMARY KEY AUTOINCREMENT, cliente TEXT, servico TEXT, 
              valor_total REAL, sinal REAL, data_servico DATE, status TEXT)''')
conn.commit()

# --- SIDEBAR ---
st.sidebar.title("üì≤ Menu de Gest√£o")
aba = st.sidebar.radio("Ir para:", ["üìä Dashboard", "üìÖ Agenda & Clientes", "üí∏ Lan√ßar Despesas", "üìã Relat√≥rios"])

# --- ABA: AGENDA ---
if aba == "üìÖ Agenda & Clientes":
    st.title("üìÖ Agenda de Servi√ßos")
    
    t1, t2 = st.tabs(["Ver Compromissos", "Novo Agendamento"])
    
    with t2:
        with st.form("novo_agendamento"):
            c1, c2 = st.columns(2)
            cliente = c1.text_input("Nome do Cliente")
            servico = c1.selectbox("Tipo de Servi√ßo", ["Transfer", "City Tour", "Particular", "Di√°ria"])
            data_s = c2.date_input("Data do Servi√ßo", datetime.now())
            v_total = c2.number_input("Valor Total Combinado (R$)", 0.0)
            v_sinal = c2.number_input("Sinal Pago (R$)", 0.0)
            
            if st.form_submit_button("Confirmar Agendamento"):
                status = "Sinal Pago" if v_sinal > 0 else "Pendente"
                c.execute("INSERT INTO agenda (cliente, servico, valor_total, sinal, data_servico, status) VALUES (?,?,?,?,?,?)",
                          (cliente, servico, v_total, v_sinal, data_s, status))
                # Se houve sinal, j√° lan√ßa como entrada no financeiro hoje
                if v_sinal > 0:
                    c.execute("INSERT INTO financeiro (tipo, cat, valor, data) VALUES (?,?,?,?)",
                              ("Entrada", f"Sinal: {cliente}", v_sinal, datetime.now().date()))
                conn.commit()
                st.success("Agendado e sinal registrado no caixa!")

    with t1:
        df_ag = pd.read_sql_query("SELECT * FROM agenda WHERE status != 'Finalizado' ORDER BY data_servico ASC", conn)
        if not df_ag.empty:
            df_ag['Restante'] = df_ag['valor_total'] - df_ag['sinal']
            st.dataframe(df_ag, use_container_width=True)
            
            st.divider()
            st.subheader("üèÅ Finalizar Servi√ßo")
            id_sel = st.selectbox("Selecione o servi√ßo conclu√≠do:", df_ag['id'].tolist(), 
                                  format_func=lambda x: f"ID {x} - {df_ag[df_ag['id']==x]['cliente'].values[0]}")
            
            if st.button("Receber Saldo e Finalizar"):
                servico_atual = df_ag[df_ag['id'] == id_sel].iloc[0]
                restante = servico_atual['Restante']
                
                # 1. Atualiza status na agenda
                c.execute("UPDATE agenda SET status='Finalizado' WHERE id=?", (id_sel,))
                # 2. Lan√ßa o restante no financeiro
                c.execute("INSERT INTO financeiro (tipo, cat, valor, data) VALUES (?,?,?,?)",
                          ("Entrada", f"Saldo: {servico_atual['cliente']}", restante, datetime.now().date()))
                conn.commit()
                st.balloons()
                st.rerun()
        else:
            st.info("Nenhum servi√ßo pendente na agenda.")

# --- ABA: DASHBOARD ---
elif aba == "üìä Dashboard":
    st.title("üìà Performance Financeira")
    df_f = pd.read_sql_query("SELECT * FROM financeiro", conn)
    
    if not df_f.empty:
        df_f['data'] = pd.to_datetime(df_f['data'])
        bruto = df_f[df_f['tipo'] == 'Entrada']['valor'].sum()
        gastos = df_f[df_f['tipo'] == 'Sa√≠da']['valor'].sum()
        liquido = bruto - gastos
        
        c1, c2, c3 = st.columns(3)
        c1.metric("Faturamento Total", f"R$ {bruto:,.2f}")
        c2.metric("Despesas Totais", f"R$ {gastos:,.2f}", delta_color="inverse")
        c3.metric("Lucro L√≠quido", f"R$ {liquido:,.2f}")
        
        fig = px.line(df_f.groupby('data')['valor'].sum().reset_index(), x='data', y='valor', title="Evolu√ß√£o do Faturamento")
        st.plotly_chart(fig, use_container_width=True)
    else:
        st.warning("Sem dados financeiros para exibir.")

# --- ABA: DESPESAS ---
elif aba == "üí∏ Lan√ßar Despesas":
    st.header("‚õΩ Registro de Gastos")
    with st.form("gastos"):
        cat_g = st.selectbox("Categoria", ["Combust√≠vel", "Manuten√ß√£o", "Aluguel", "Alimenta√ß√£o", "Outros"])
        val_g = st.number_input("Valor gasto (R$)", 0.0)
        dat_g = st.date_input("Data", datetime.now())
        if st.form_submit_button("Salvar Gasto"):
            c.execute("INSERT INTO financeiro (tipo, cat, valor, data) VALUES (?,?,?,?)",
                      ("Sa√≠da", cat_g, val_g, dat_g))
            conn.commit()
            st.success("Gasto registrado!")

# --- ABA: RELAT√ìRIOS ---
elif aba == "üìã Relat√≥rios":
    st.header("Relat√≥rio Geral")
    df_all = pd.read_sql_query("SELECT * FROM financeiro ORDER BY data DESC", conn)
    st.dataframe(df_all, use_container_width=True)
