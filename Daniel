import streamlit as st
import pandas as pd
import sqlite3
import plotly.express as px
from datetime import datetime

# --- SEGURAN√áA ---
def check_password():
    def password_entered():
        if st.session_state["password"] == "admin123":
            st.session_state["password_correct"] = True
            del st.session_state["password"]
        else:
            st.session_state["password_correct"] = False

    if "password_correct" not in st.session_state:
        st.title("üîê Acesso Restrito - Daniel")
        st.text_input("Digite a senha", type="password", on_change=password_entered, key="password")
        return False
    return st.session_state["password_correct"]

if check_password():
    # --- CONFIGURA√á√ÉO E BANCO DE DADOS ---
    st.set_page_config(page_title="Gest√£o Daniel VIP", layout="wide")
    conn = sqlite3.connect('dados_viva_daniel.db', check_same_thread=False)
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS financeiro (id INTEGER PRIMARY KEY AUTOINCREMENT, tipo TEXT, cat TEXT, valor REAL, data DATE)''')
    c.execute('''CREATE TABLE IF NOT EXISTS agenda (id INTEGER PRIMARY KEY AUTOINCREMENT, cliente TEXT, servico TEXT, valor_total REAL, sinal REAL, data_servico DATE, status TEXT)''')
    conn.commit()

    # --- MENU LATERAL ---
    st.sidebar.title("üì≤ Menu Principal")
    aba = st.sidebar.radio("Navega√ß√£o", ["üìä Dashboard", "üìÖ Agenda & Sinais", "üí∏ Sa√≠das/Gastos", "üìã Relat√≥rio Geral"])

    # --- ABA: DASHBOARD ---
    if aba == "üìä Dashboard":
        st.title("üìä Resumo do Neg√≥cio")
        df_f = pd.read_sql_query("SELECT * FROM financeiro", conn)
        
        if not df_f.empty:
            df_f['data'] = pd.to_datetime(df_f['data'])
            bruto = df_f[df_f['tipo'] == 'Entrada']['valor'].sum()
            gastos = df_f[df_f['tipo'] == 'Sa√≠da']['valor'].sum()
            
            c1, c2, c3 = st.columns(3)
            c1.metric("Faturamento Bruto", f"R$ {bruto:,.2f}")
            c2.metric("Despesas Totais", f"R$ {gastos:,.2f}", delta_color="inverse")
            c3.metric("Lucro L√≠quido", f"R$ {bruto - gastos:,.2f}")

            st.divider()
            col_g1, col_g2 = st.columns(2)
            with col_g1:
                fig_pizza = px.pie(df_f[df_f['tipo']=='Entrada'], values='valor', names='cat', title="Origem das Entradas")
                st.plotly_chart(fig_pizza, use_container_width=True)
            with col_g2:
                df_evolucao = df_f.groupby('data')['valor'].sum().reset_index()
                fig_linha = px.line(df_evolucao, x='data', y='valor', title="Evolu√ß√£o Financeira")
                st.plotly_chart(fig_linha, use_container_width=True)
        else:
            st.info("Lance dados na Agenda ou Gastos para ativar os gr√°ficos.")

    # --- ABA: AGENDA ---
    elif aba == "üìÖ Agenda & Sinais":
        st.title("üìÖ Agendamentos e Recebimentos")
        t1, t2 = st.tabs(["üìã Lista de Clientes", "‚ûï Novo Agendamento"])
        
        with t2:
            with st.form("add_agenda"):
                col1, col2 = st.columns(2)
                cli = col1.text_input("Nome do Cliente")
                serv = col1.selectbox("Servi√ßo", ["Transfer", "City Tour", "Particular", "Outros"])
                dat_s = col2.date_input("Data do Servi√ßo")
                v_tot = col2.number_input("Valor Total Combinado", 0.0)
                v_sin = col2.number_input("Valor do Sinal Pago", 0.0)
                if st.form_submit_button("Agendar"):
                    status = "Sinal Pago" if v_sin > 0 else "Pendente"
                    c.execute("INSERT INTO agenda (cliente, servico, valor_total, sinal, data_servico, status) VALUES (?,?,?,?,?,?)",
                              (cli, serv, v_tot, v_sin, dat_s, status))
                    if v_sin > 0:
                        c.execute("INSERT INTO financeiro (tipo, cat, valor, data) VALUES (?,?,?,?)", ("Entrada", f"Sinal: {cli}", v_sin, datetime.now().date()))
                    conn.commit()
                    st.success("‚úÖ Agendamento Realizado!")
        
        with t1:
            df_ag = pd.read_sql_query("SELECT * FROM agenda WHERE status != 'Finalizado'", conn)
            if not df_ag.empty:
                df_ag['Restante'] = df_ag['valor_total'] - df_ag['sinal']
                st.dataframe(df_ag, use_container_width=True)
                st.divider()
                id_f = st.selectbox("Selecione ID do servi√ßo conclu√≠do hoje:", df_ag['id'].tolist())
                if st.button("üèÅ Confirmar Recebimento e Finalizar"):
                    row = df_ag[df_ag['id'] == id_f].iloc[0]
                    restante = row['valor_total'] - row['sinal']
                    c.execute("UPDATE agenda SET status='Finalizado' WHERE id=?", (id_f,))
                    c.execute("INSERT INTO financeiro (tipo, cat, valor, data) VALUES (?,?,?,?)", ("Entrada", f"Saldo: {row['cliente']}", restante, datetime.now().date()))
                    conn.commit()
                    st.rerun()
            else:
                st.info("Nenhum agendamento pendente.")

    # --- ABA: GASTOS ---
    elif aba == "üí∏ Sa√≠das/Gastos":
        st.title("üí∏ Registro de Despesas")
        with st.form("gastos"):
            cat_s = st.selectbox("Categoria", ["Gasolina", "Alimenta√ß√£o", "Manuten√ß√£o", "Aluguel Carro", "Aluguel Casa", "Outros"])
            val_s = st.number_input("Valor do Gasto", 0.0)
            if st.form_submit_button("Salvar Despesa"):
                c.execute("INSERT INTO financeiro (tipo, cat, valor, data) VALUES (?,?,?,?)", ("Sa√≠da", cat_s, val_s, datetime.now().date()))
                conn.commit()
                st.success("Despesa registrada!")

    # --- ABA: HIST√ìRICO ---
    elif aba == "üìã Relat√≥rio Geral":
        st.title("üìã Hist√≥rico de Movimenta√ß√µes")
        df_hist = pd.read_sql_query("SELECT * FROM financeiro ORDER BY data DESC", conn)
        st.dataframe(df_hist, use_container_width=True)
