import streamlit as st
import pandas as pd
import sqlite3
from datetime import datetime, timedelta

# ConfiguraÃ§Ãµes iniciais
st.set_page_config(page_title="GestÃ£o de Transportes Pro", layout="wide")

# --- BANCO DE DADOS ---
conn = sqlite3.connect('financeiro_transporte.db', check_same_thread=False)
c = conn.cursor()
c.execute('''CREATE TABLE IF NOT EXISTS financeiro 
             (tipo TEXT, categoria TEXT, valor REAL, sinal_pct REAL, km_inicial REAL, km_final REAL, data TEXT)''')
conn.commit()

# --- SIDEBAR (METAS E NAVEGAÃ‡ÃƒO) ---
st.sidebar.title("ConfiguraÃ§Ãµes")
meta_diaria = st.sidebar.number_input("Sua Meta DiÃ¡ria (R$)", value=300.0)
menu = st.sidebar.selectbox("Ir para:", ["Registrar Hoje", "RelatÃ³rios DiÃ¡rios", "VisÃ£o Semana/MÃªs"])

# --- LÃ“GICA DE REGISTRO ---
if menu == "Registrar Hoje":
    st.header("ðŸ“ Registro de Atividades")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.subheader("Entradas")
        tipo_entrada = st.selectbox("Categoria de Entrada", ["Uber", "ComissÃ£o", "Particular", "Transfer", "City tour", "Outros"])
        valor_total = st.number_input("Valor Total do ServiÃ§o (R$)", min_value=0.0)
        
        # Campo de Sinal para City Tour e Transfer
        sinal = 0.0
        if tipo_entrada in ["Transfer", "City tour"]:
            sinal = st.slider("Sinal recebido (%)", 0, 100, 0)
            valor_sinal = (valor_total * sinal) / 100
            st.info(f"Valor do Sinal: R$ {valor_sinal:.2f}")

    with col2:
        st.subheader("SaÃ­das / KM")
        cat_saida = st.selectbox("Categoria de SaÃ­da", ["Nenhuma", "Gasolina", "AlimentaÃ§Ã£o", "Mercado", "Contas de Consumo", "Aluguel carro", "Aluguel casa"])
        valor_saida = st.number_input("Valor da SaÃ­da (R$)", min_value=0.0)
        
        st.divider()
        km_i = st.number_input("KM Inicial", min_value=0.0)
        km_f = st.number_input("KM Final", min_value=0.0)

    if st.button("Salvar Registro"):
        data_hoje = datetime.now().strftime("%Y-%m-%d")
        # Salva Entrada (se houver)
        if valor_total > 0:
            c.execute("INSERT INTO financeiro VALUES (?, ?, ?, ?, ?, ?, ?)", 
                      ('Entrada', tipo_entrada, valor_total, sinal, km_i, km_f, data_hoje))
        # Salva SaÃ­da (se houver)
        if valor_saida > 0:
            c.execute("INSERT INTO financeiro VALUES (?, ?, ?, ?, ?, ?, ?)", 
                      ('SaÃ­da', cat_saida, valor_saida, 0, 0, 0, data_hoje))
        conn.commit()
        st.success("Dados salvos com sucesso!")

# --- LÃ“GICA DE RELATÃ“RIOS ---
else:
    df = pd.read_sql_query("SELECT * FROM financeiro", conn)
    df['data'] = pd.to_datetime(df['data'])
    
    if menu == "RelatÃ³rios DiÃ¡rios":
        hoje = datetime.now().date()
        df_hoje = df[df['data'].dt.date == hoje]
        
        ganho_hoje = df_hoje[df_hoje['tipo'] == 'Entrada']['valor'].sum()
        gasto_hoje = df_hoje[df_hoje['tipo'] == 'SaÃ­da']['valor'].sum()
        
        st.header(f"Resumo de Hoje: {hoje.strftime('%d/%m/%Y')}")
        
        # Barra de Meta
        progresso = min(ganho_hoje / meta_diaria, 1.0) if meta_diaria > 0 else 0
        st.write(f"Meta DiÃ¡ria: R$ {ganho_hoje:.2f} / R$ {meta_diaria:.2f}")
        st.progress(progresso)
        
        col1, col2, col3 = st.columns(3)
        col1.metric("Ganhos", f"R$ {ganho_hoje:.2f}")
        col2.metric("Gastos", f"R$ {gasto_hoje:.2f}")
        col3.metric("Saldo", f"R$ {ganho_hoje - gasto_hoje:.2f}")

    elif menu == "VisÃ£o Semana/MÃªs":
        st.header("AnÃ¡lise por PerÃ­odo")
        periodo = st.radio("Escolha a visÃ£o:", ["Ãšltimos 7 Dias", "MÃªs Atual"])
        
        data_limite = datetime.now() - timedelta(days=7) if periodo == "Ãšltimos 7 Dias" else datetime.now().replace(day=1)
        df_filtro = df[df['data'] >= data_limite]
        
        st.dataframe(df_filtro, use_container_width=True)
        
        resumo = df_filtro.groupby('tipo')['valor'].sum()
        st.json(resumo.to_dict())
